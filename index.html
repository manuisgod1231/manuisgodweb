<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡πÅ‡∏≠‡∏õ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</title>
<meta name="theme-color" content="#4CAF50">

<!-- PWA manifest ‡πÅ‡∏ö‡∏ö inline -->
<script type="application/manifest+json" id="manifest">
{
  "name": "‡πÅ‡∏≠‡∏õ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô",
  "short_name": "‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô",
  "start_url": "./",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#4CAF50",
  "icons": [
    { "src": "https://via.placeholder.com/192", "sizes": "192x192", "type": "image/png" },
    { "src": "https://via.placeholder.com/512", "sizes": "512x512", "type": "image/png" }
  ]
}
</script>

<style>
body {font-family:sans-serif; margin:0; padding:20px; display:flex; justify-content:center; background:#f4f4f4;}
.container {width:95%; max-width:800px; background:#fff; padding:20px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.2);}
h2 {margin-top:0; text-align:center;}
details {margin:10px 0; border:1px solid #ccc; border-radius:8px; padding:10px; background:#fafafa;}
details summary {font-weight:bold; cursor:pointer;}
.input-row {display:flex; gap:10px; margin-bottom:10px;}
.input-row input {flex:1; padding:6px;}
button {padding:8px 16px; margin-top:10px; cursor:pointer; border:none; border-radius:6px; background:#007bff; color:white;}
button:hover {background:#0056b3;}
#result {margin-top:20px; padding:15px; border-radius:8px; background:#e9f7ef; border:1px solid #28a745;}
#saveImageBtn {background:#28a745; margin-left:10px; display:none;}
#donateBtn {position:fixed; left:20px; bottom:20px; z-index:1000; background:none; border:none; cursor:pointer;}
#donateBtn img {width:60px; height:60px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.3); transition: transform 0.2s;}
#donateBtn img:hover {transform: scale(1.1);}
#donatePopup {display:none; position:fixed; z-index:2000; left:0; top:0; width:100%; height:100%; background: rgba(0,0,0,0.7); justify-content:center; align-items:center;}
.popup-content {position:relative; background:#fff; padding:15px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.5);}
.popup-content img {max-width:350px; max-height:80vh; border-radius:8px;}
#closePopup {position:absolute; top:5px; right:10px; font-size:26px; font-weight:bold; cursor:pointer; color:#333;}
#installPopup {display:none; position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#fff; padding:15px; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.3); z-index:3000; text-align:center; max-width:300px;}
#installPopup button {padding:6px 12px; border:none; border-radius:6px; cursor:pointer; margin-top:8px;}
#installPopup .closeBtn {background:#ccc; margin-top:5px;}
</style>
</head>
<body>

<div class="container" id="appContent">
  <h2>üìä ‡πÅ‡∏≠‡∏õ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</h2>

  <!-- ‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á/‡∏Ñ‡∏ô + ‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥/‡πÑ‡∏ü -->
  <details open>
    <summary>üíº ‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á & ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</summary>
    <div class="input-row">
      <input type="number" id="workers" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô">
      <input type="number" id="wage" placeholder="‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á‡∏ï‡πà‡∏≠‡∏Ñ‡∏ô">
    </div>
    <div class="input-row">
      <input type="number" id="water" placeholder="‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥">
      <input type="number" id="electricity" placeholder="‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü">
    </div>
  </details>

  <!-- ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö -->
  <details>
    <summary>ü•¶ ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</summary>
    <div id="materials"></div>
    <button onclick="addMaterial()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</button>
  </details>

  <!-- ‡∏Å‡∏≥‡πÑ‡∏£ -->
  <details>
    <summary>üí∞ ‡∏Å‡∏≥‡πÑ‡∏£</summary>
    <div class="input-row">
      <input type="number" id="profit" placeholder="‡∏Å‡∏≥‡πÑ‡∏£ %">
      <select id="profitType">
        <option value="day">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</option>
        <option value="month" selected>‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
        <option value="year">‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</option>
      </select>
      <input type="number" id="duration" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏ß‡∏±‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ)">
    </div>
  </details>

  <button onclick="calculate()">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</button>
  <button id="saveImageBtn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏†‡∏≤‡∏û</button>
  <div id="result"></div>
</div>

<!-- Donate -->
<button id="donateBtn">
  <img src="https://drive.google.com/uc?export=view&id=1M3FLPg5jJQraRE3weUtRLGMiUro5JJcK" alt="Donate">
</button>
<div id="donatePopup">
  <div class="popup-content">
    <span id="closePopup">&times;</span>
    <img src="https://drive.google.com/uc?export=view&id=1M3FLPg5jJQraRE3weUtRLGMiUro5JJcK" alt="Donate QR">
  </div>
</div>

<!-- Add to Home -->
<div id="installPopup">
  <p>üì≤ ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏≠‡∏õ‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÇ‡∏Æ‡∏° ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÅ‡∏≠‡∏õ‡∏à‡∏£‡∏¥‡∏á</p>
  <button id="installBtn">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÇ‡∏Æ‡∏°</button>
  <button class="closeBtn" onclick="document.getElementById('installPopup').style.display='none'">‡∏õ‡∏¥‡∏î</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
let materialCount = 0;

// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö
function addMaterial(name="", cost=""){
  materialCount++;
  const div = document.createElement("div");
  div.className = "input-row";
  div.id = "material-" + materialCount;
  div.innerHTML = `
    <input type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö" value="${name}">
    <input type="text" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤ (‡πÉ‡∏™‡πà‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÑ‡∏î‡πâ)" value="${cost}">
    <button onclick="editMaterial(${materialCount})">‚öôÔ∏è</button>
    <button onclick="deleteMaterial(${materialCount})">‚ùå</button>
  `;
  document.getElementById("materials").appendChild(div);
}

function deleteMaterial(id){document.getElementById("material-"+id).remove();}
function editMaterial(id){
  const div = document.getElementById("material-"+id);
  const inputs = div.getElementsByTagName("input");
  inputs[0].disabled = !inputs[0].disabled;
  inputs[1].disabled = !inputs[1].disabled;
}

// ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
function calculate(){
  const workers = parseFloat(document.getElementById("workers").value)||0;
  const wage = parseFloat(document.getElementById("wage").value)||0;
  const water = parseFloat(document.getElementById("water").value)||0;
  const electricity = parseFloat(document.getElementById("electricity").value)||0;
  const profit = parseFloat(document.getElementById("profit").value)||0;
  const profitType = document.getElementById("profitType").value;
  const duration = parseFloat(document.getElementById("duration").value)||1;

  let materialCost = 0;
  document.querySelectorAll("#materials .input-row").forEach(row=>{
    const cost=parseFloat(row.children[1].value)||0;
    materialCost += cost;
  });

  const laborCost = workers*wage;
  const otherCost = water+electricity;
  const totalCost = laborCost + otherCost + materialCost;

  let profitTotal = totalCost*(profit/100);
  profitTotal *= duration;

  document.getElementById("result").innerHTML=`
    üíº ‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á‡∏£‡∏ß‡∏°: ${laborCost} ‡∏ö‡∏≤‡∏ó<br>
    üíß ‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥ + ‚ö° ‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü: ${otherCost} ‡∏ö‡∏≤‡∏ó<br>
    ü•¶ ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö: ${materialCost} ‡∏ö‡∏≤‡∏ó<br>
    üìä ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°: ${totalCost} ‡∏ö‡∏≤‡∏ó<br>
    üí∞ ‡∏Å‡∏≥‡πÑ‡∏£ (${profit}% / ${profitType}): ${profitTotal} ‡∏ö‡∏≤‡∏ó
  `;
  document.getElementById("saveImageBtn").style.display="inline-block";
}

// ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏†‡∏≤‡∏û
document.getElementById("saveImageBtn").addEventListener("click", ()=>{
  html2canvas(document.getElementById("appContent")).then(canvas=>{
    const link=document.createElement("a");
    link.download="calculation.png";
    link.href=canvas.toDataURL();
    link.click();
  });
});

// Donate popup
const donateBtn=document.getElementById("donateBtn");
const donatePopup=document.getElementById("donatePopup");
const closePopup=document.getElementById("closePopup");
donateBtn.addEventListener("click",()=>{donatePopup.style.display="flex";});
closePopup.addEventListener("click",()=>{donatePopup.style.display="none";});
donatePopup.addEventListener("click",(e)=>{if(e.target===donatePopup) donatePopup.style.display="none";});

// Add to Home
let deferredPrompt;
window.addEventListener("beforeinstallprompt",(e)=>{
  e.preventDefault();
  deferredPrompt=e;
  document.getElementById("installPopup").style.display="block";
});
document.getElementById("installBtn").addEventListener("click", async ()=>{
  document.getElementById("installPopup").style.display="none";
  if(deferredPrompt){
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then(()=>{deferredPrompt=null;});
  }
});

// Service Worker ‡πÅ‡∏ö‡∏ö inline
if("serviceWorker" in navigator){
  const swCode=`self.addEventListener("install",e=>{self.skipWaiting();});
  self.addEventListener("activate",e=>{clients.claim();});
  self.addEventListener("fetch",e=>{});`;
  const blob=new Blob([swCode],{type:"application/javascript"});
  navigator.serviceWorker.register(URL.createObjectURL(blob)).then(reg=>{
    console.log("SW registered");
    reg.onupdatefound=()=>{const newWorker=reg.installing;
      newWorker.onstatechange=()=>{if(newWorker.state==="installed"&&navigator.serviceWorker.controller){
        console.log("üîÑ update detected, reload");
        window.location.reload();}};};
  });
}
</script>
</body>
</html>
